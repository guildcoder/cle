<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Livestock Bidding — Create Lot</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui,Segoe UI,Roboto,Helvetica,Arial; padding:24px; max-width:800px; margin:0 auto; }
    label { display:block; margin-top:12px; font-weight:600; }
    input, textarea, select { width:100%; padding:8px; margin-top:6px; box-sizing:border-box; }
    button { margin-top:14px; padding:10px 16px; font-size:16px; }
    .row { display:flex; gap:12px; }
    .small { width:160px; }
    img.preview { max-width:320px; margin-top:12px; border:1px solid #ddd; }
    .note { color:#666; font-size:13px; margin-top:8px; }
  </style>
</head>
<body>
  <h1>Create a Sale Lot</h1>

  <label>Photo (jpg/png)
    <input id="imageFile" type="file" accept="image/*" />
  </label>
  <img id="preview" class="preview" src="" alt="" style="display:none" />

  <label>Title
    <input id="title" type="text" placeholder="Lot title (e.g., 'Angus Heifer #12')" />
  </label>

  <label>Lot Number (optional)
    <input id="lotNumber" type="text" placeholder="Lot number (e.g., 12)" />
  </label>

  <label>Pedigree
    <textarea id="pedigree" rows="3" placeholder="Pedigree / breeding info"></textarea>
  </label>

  <label>Description
    <textarea id="description" rows="4" placeholder="Describe the animal"></textarea>
  </label>

  <div class="row">
    <div>
      <label>Starting Price (USD)
        <input id="startPrice" type="number" min="0" step="1" value="0"/>
      </label>
    </div>
    <div>
      <label>Bid Increment (USD)
        <input id="increment" type="number" min="1" step="1" value="50"/>
      </label>
    </div>
  </div>

  <label>Sale end (optional)
    <input id="endsAt" type="datetime-local" />
  </label>

  <button id="createBtn">Create Lot</button>

  <p class="note">When created, a Lot ID will appear — use that ID in your live bidding URL as <code>live.html?lotId=THE_ID</code>.</p>

  <pre id="result" style="background:#f9f9f9;padding:12px;border-radius:6px;display:none;"></pre>

  <!-- Firebase SDK (modular) -->
  <script type="module">
    // ---------------------------
    // Replace with your firebaseConfig (you provided it already)
    // ---------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyBri9ILoCR21RS1ow2epFocbka63sLOSEM",
      authDomain: "dugout-live-96480.firebaseapp.com",
      projectId: "dugout-live-96480",
      storageBucket: "dugout-live-96480.firebasestorage.app",
      messagingSenderId: "183818216509",
      appId: "1:183818216509:web:792137f59b46123446b654",
      measurementId: "G-43HN5BNN92"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp, updateDoc, doc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const imageFile = document.getElementById('imageFile');
    const preview = document.getElementById('preview');
    imageFile.addEventListener('change', async (e) => {
      const f = e.target.files[0];
      if (!f) { preview.style.display = 'none'; return; }
      preview.src = URL.createObjectURL(f);
      preview.style.display = 'block';
    });

    document.getElementById('createBtn').addEventListener('click', async () => {
      const file = imageFile.files[0];
      const title = document.getElementById('title').value.trim();
      const lotNumber = document.getElementById('lotNumber').value.trim();
      const pedigree = document.getElementById('pedigree').value.trim();
      const description = document.getElementById('description').value.trim();
      const startPrice = Number(document.getElementById('startPrice').value) || 0;
      const increment = Number(document.getElementById('increment').value) || 1;
      const endsAtVal = document.getElementById('endsAt').value;
      const endsAt = endsAtVal ? new Date(endsAtVal) : null;

      if (!title) return alert('Please provide a title.');
      if (!file) return alert('Please attach an image for the lot.');
      if (increment <= 0) return alert('Bid increment must be at least 1.');

      try {
        // upload image
        const storagePath = `lots/${Date.now()}_${file.name}`;
        const stRef = sRef(storage, storagePath);
        const uploadRes = await uploadBytes(stRef, file);
        const imageURL = await getDownloadURL(stRef);

        // create lot doc
        const lotData = {
          title,
          lotNumber: lotNumber || null,
          pedigree: pedigree || '',
          description: description || '',
          imageURL,
          startPrice,
          increment,
          createdAt: serverTimestamp(),
          currentBid: null,         // empty until bids come in
          currentBidderName: null,
          currentBidderMaskedPhone: null,
          endsAt: endsAt ? endsAt.toISOString() : null
        };

        const lotsCol = collection(db, 'lots');
        const newLotRef = await addDoc(lotsCol, lotData);

        // Provide the link
        const liveUrl = `${location.origin}${location.pathname.replace(/index\.html$/,'')}live.html?lotId=${newLotRef.id}`;

        const resultEl = document.getElementById('result');
        resultEl.style.display = 'block';
        resultEl.textContent = `Lot created!\nID: ${newLotRef.id}\nOpen live bidding page:\n${liveUrl}\n\nKeep the Lot ID safe.`;
        alert('Lot created successfully — see details below.');

      } catch (err) {
        console.error(err);
        alert('Error creating lot: ' + err.message);
      }
    });
  </script>
</body>
</html>
